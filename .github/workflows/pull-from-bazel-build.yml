name: Pull Bazel Build Upstream Repo

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
    # called from trigger-from-bazel-repo.yml
  workflow_dispatch:
    inputs:
        bazelCommitHash:
          description: 'The commit hash of the Bazel repo to use'
          type: string
          default: origin/main
  # allow debugging by triggering from the GitHub UI
  workflow_call:
    inputs:
        bazelCommitHash:
          description: 'The commit hash of the Bazel repo to use'
          type: string
          default: origin/main
jobs:
  pull-fresh-upstream:
    # don't run on dependabot PRs
    if: ${{ github.event.pull_request.user.login != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
        - uses: actions/checkout@v5
          with:
            # Don't auto-init submodules
            submodules: false

        - name: Checkout submodules
          run: git submodule update --init -- upstream

        - name: Checkout commit of Bazel Build submodule
          if: ${{ inputs.bazelCommitHash != '' }}
          working-directory: upstream
          run: git checkout '${{ inputs.bazelCommitHash }}'

        - name: Setup Bazel
          uses: bazel-contrib/setup-bazel@0.15.0
          with:
            bazelisk-cache: true
            disk-cache: ${{ github.workflow }}
            repository-cache: true

        - name: Build reference documentation
          working-directory: upstream
          run: bazel build //src/main/java/com/google/devtools/build/lib:gen_reference_docs --config=docs

        - name: Clean up mdx files
          run: ./cleanup-mdx.sh

        - name: Transform upstream docs to mdx
          run: ./copy-upstream-docs.sh

        - name: Create versioned navigation
          run: ./docs.json.update.sh
